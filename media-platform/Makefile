.PHONY: build run clean docker-build docker-up docker-down docker-logs psql help migrate-up migrate-down db-reset

# å¤‰æ•°å®šç¾©
APP_NAME = media-platform
# âœ… ä¿®æ­£: docker-compose (ãƒã‚¤ãƒ•ãƒ³ä»˜ã) ã«å¤‰æ›´
DOCKER_COMPOSE = docker-compose

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
all: help

# ===============================================
# ãƒ˜ãƒ«ãƒ—
# ===============================================
help:
	@echo "=============================================="
	@echo "ğŸš€ Media Platform - é–‹ç™ºã‚³ãƒãƒ³ãƒ‰"
	@echo "=============================================="
	@echo ""
	@echo "ğŸ“¦ Dockerç®¡ç†:"
	@echo "  make docker-build    - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make docker-up       - ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•"
	@echo "  make docker-down     - ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢"
	@echo "  make docker-logs     - ãƒ­ã‚°ã‚’è¡¨ç¤º"
	@echo "  make docker-restart  - ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•"
	@echo ""
	@echo "ğŸ—„ï¸  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†:"
	@echo "  make psql            - PostgreSQLã«ã‚¢ã‚¯ã‚»ã‚¹"
	@echo "  make migrate-up      - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨"
	@echo "  make migrate-down    - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’1ã¤æˆ»ã™"
	@echo "  make migrate-version - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º"
	@echo "  make db-reset        - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ"
	@echo ""
	@echo "ğŸ”§ ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º:"
	@echo "  make build           - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰"
	@echo "  make run             - ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ"
	@echo "  make clean           - ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤"
	@echo ""
	@echo "=============================================="

# ===============================================
# Dockerç®¡ç†
# ===============================================
docker-build:
	@echo "ğŸ”¨ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	$(DOCKER_COMPOSE) build
	@echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"

docker-up:
	@echo "ğŸš€ ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ä¸­..."
	$(DOCKER_COMPOSE) up -d
	@echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¾ã—ãŸ"
	@echo "ğŸ“ Frontend: http://localhost:3000"
	@echo "ğŸ“ Backend:  http://localhost:8082"

docker-down:
	@echo "ğŸ›‘ ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ä¸­..."
	$(DOCKER_COMPOSE) down
	@echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹ãŒåœæ­¢ã—ã¾ã—ãŸ"

docker-logs:
	@echo "ğŸ“‹ ãƒ­ã‚°ã‚’è¡¨ç¤ºä¸­..."
	$(DOCKER_COMPOSE) logs -f

docker-restart:
	@echo "ğŸ”„ ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ä¸­..."
	$(DOCKER_COMPOSE) restart
	@echo "âœ… å†èµ·å‹•å®Œäº†"

# ===============================================
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†
# ===============================================
psql:
	@echo "ğŸ”Œ PostgreSQLã«æ¥ç¶šä¸­..."
	$(DOCKER_COMPOSE) exec postgres psql -U postgres -d media_platform

migrate-up:
	@echo "ğŸš€ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ä¸­..."
	$(DOCKER_COMPOSE) exec api migrate -path /app/migrations -database "postgres://postgres:postgres@postgres:5432/media_platform?sslmode=disable" up
	@echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†"

migrate-down:
	@echo "âª ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’1ã¤æˆ»ã—ã¾ã™..."
	$(DOCKER_COMPOSE) exec api migrate -path /app/migrations -database "postgres://postgres:postgres@postgres:5432/media_platform?sslmode=disable" down 1
	@echo "âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†"

migrate-version:
	@echo "ğŸ“Œ ç¾åœ¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³:"
	@$(DOCKER_COMPOSE) exec api migrate -path /app/migrations -database "postgres://postgres:postgres@postgres:5432/media_platform?sslmode=disable" version

db-reset:
	@echo "âš ï¸  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆä¸­..."
	$(DOCKER_COMPOSE) down -v
	$(DOCKER_COMPOSE) up -d postgres
	@echo "â³ PostgreSQLã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
	@sleep 5
	@make migrate-up
	@echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒªã‚»ãƒƒãƒˆå®Œäº†"

# ===============================================
# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º
# ===============================================
build:
	@echo "ğŸ”¨ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	cd backend && go build -o bin/$(APP_NAME) ./cmd/api/main.go
	@echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"

run:
	@echo "ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œä¸­..."
	cd backend && go run ./cmd/api/main.go

clean:
	@echo "ğŸ§¹ ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ä¸­..."
	rm -rf backend/bin/$(APP_NAME)
	@echo "âœ… å‰Šé™¤å®Œäº†"