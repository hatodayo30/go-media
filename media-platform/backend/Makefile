# ===============================================
# Backendç”¨ Makefile (ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†)
# ===============================================

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæƒ…å ±
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=postgres
DB_NAME=media_platform
DB_URL=postgres://$(DB_USER):$(DB_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(DB_NAME)?sslmode=disable

# Dockerç’°å¢ƒç”¨ã®DB URL
DOCKER_DB_URL=postgres://$(DB_USER):$(DB_PASSWORD)@postgres:$(DB_PORT)/$(DB_NAME)?sslmode=disable

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
MIGRATIONS_PATH=./migrations

.PHONY: help migrate-up migrate-down migrate-force migrate-version migrate-create migrate-drop db-reset

# ===============================================
# ãƒ˜ãƒ«ãƒ—
# ===============================================
help: ## ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@echo "=============================================="
	@echo "ğŸ“¦ Backend ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†"
	@echo "=============================================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-25s\033[0m %s\n", $$1, $$2}'

# ===============================================
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†
# ===============================================
migrate-up: ## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
	@echo "ğŸš€ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ä¸­..."
	migrate -path $(MIGRATIONS_PATH) -database "$(DB_URL)" up
	@echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†"

migrate-down: ## æœ€æ–°ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’1ã¤æˆ»ã™
	@echo "âª ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’1ã¤æˆ»ã—ã¾ã™..."
	migrate -path $(MIGRATIONS_PATH) -database "$(DB_URL)" down 1
	@echo "âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†"

migrate-force: ## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¼·åˆ¶è¨­å®š (make migrate-force VERSION=1)
	@echo "ğŸ”§ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ $(VERSION) ã«è¨­å®šä¸­..."
	migrate -path $(MIGRATIONS_PATH) -database "$(DB_URL)" force $(VERSION)
	@echo "âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨­å®šå®Œäº†"

migrate-version: ## ç¾åœ¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¡¨ç¤º
	@echo "ğŸ“Œ ç¾åœ¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³:"
	@migrate -path $(MIGRATIONS_PATH) -database "$(DB_URL)" version

migrate-create: ## æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ (make migrate-create NAME=add_table)
	@echo "ğŸ“ æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ: $(NAME)"
	migrate create -ext sql -dir $(MIGRATIONS_PATH) -seq $(NAME)
	@echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"

migrate-drop: ## ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ (âš ï¸ æ³¨æ„: æœ¬ç•ªç’°å¢ƒã§ã¯ä½¿ç”¨ç¦æ­¢)
	@echo "âš ï¸  è­¦å‘Š: ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™"
	@read -p "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹? (yes/no): " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		migrate -path $(MIGRATIONS_PATH) -database "$(DB_URL)" drop -f; \
		echo "âœ… ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; \
	fi

db-reset: migrate-drop migrate-up ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ (å‰Šé™¤ â†’ å†æ§‹ç¯‰)

# ===============================================
# Dockerç’°å¢ƒç”¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
# ===============================================
docker-migrate-up: ## Dockerç’°å¢ƒã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
	@echo "ğŸ³ Dockerç’°å¢ƒã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ä¸­..."
	docker compose exec api migrate -path /app/migrations -database "$(DOCKER_DB_URL)" up
	@echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†"

docker-migrate-down: ## Dockerç’°å¢ƒã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’1ã¤æˆ»ã™
	@echo "ğŸ³ Dockerç’°å¢ƒã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æˆ»ã—ã¾ã™..."
	docker compose exec api migrate -path /app/migrations -database "$(DOCKER_DB_URL)" down 1
	@echo "âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†"

docker-migrate-version: ## Dockerç’°å¢ƒã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¡¨ç¤º
	@echo "ğŸ³ Dockerç’°å¢ƒã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³:"
	@docker compose exec api migrate -path /app/migrations -database "$(DOCKER_DB_URL)" version