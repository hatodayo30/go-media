import React, { useState, useEffect, useCallback } from "react";
import { api } from "../services/api";

interface ContentActionsProps {
  contentId: number;
  size?: "small" | "medium" | "large";
  showCounts?: boolean;
}

interface ActionStats {
  goods: number; // likes â†’ goods ã«å¤‰æ›´
}

interface UserActions {
  hasGood: boolean; // hasLiked â†’ hasGood ã«å¤‰æ›´
  goodId?: number; // likeId â†’ goodId ã«å¤‰æ›´
}

const ContentActions: React.FC<ContentActionsProps> = ({
  contentId,
  size = "medium",
  showCounts = true,
}) => {
  const [stats, setStats] = useState<ActionStats>({
    goods: 0, // likes â†’ goods ã«å¤‰æ›´
  });
  const [userActions, setUserActions] = useState<UserActions>({
    hasGood: false, // hasLiked â†’ hasGood ã«å¤‰æ›´
  });
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // ã‚µã‚¤ã‚ºã«å¿œã˜ãŸã‚¹ã‚¿ã‚¤ãƒ«
  const sizes = {
    small: {
      fontSize: "0.875rem",
      padding: "0.375rem 0.75rem",
      gap: "0.5rem",
      iconSize: "1rem",
    },
    medium: {
      fontSize: "1rem",
      padding: "0.5rem 1rem",
      gap: "0.75rem",
      iconSize: "1.25rem",
    },
    large: {
      fontSize: "1.125rem",
      padding: "0.75rem 1.25rem",
      gap: "1rem",
      iconSize: "1.5rem",
    },
  };

  const currentSize = sizes[size];

  const fetchActions = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      console.log(`ğŸ¯ è©•ä¾¡ãƒ‡ãƒ¼ã‚¿å–å¾—: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ID ${contentId}`);

      // è©•ä¾¡çµ±è¨ˆã‚’å–å¾—ï¼ˆæ—¢å­˜ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ï¼‰
      const statsResponse = await api.getAverageRating(contentId.toString()); // æ—¢å­˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
      const statsData = statsResponse.data || statsResponse;

      console.log("ğŸ“Š çµ±è¨ˆãƒ‡ãƒ¼ã‚¿:", statsData); // ãƒ‡ãƒãƒƒã‚°ç”¨

      setStats({
        goods: statsData.good_count || statsData.like_count || 0, // good_count ã¾ãŸã¯ like_count
      });

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©•ä¾¡çŠ¶æ…‹ç¢ºèªï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿ï¼‰
      if (isAuthenticated) {
        const ratingsResponse = await api.getRatingsByContent(
          contentId.toString()
        );
        const ratings =
          ratingsResponse.data?.ratings || ratingsResponse.ratings || [];

        const user = JSON.parse(localStorage.getItem("user") || "{}");
        const userId = user.id;

        if (userId) {
          const userGood = ratings.find(
            (
              r: any // userLike â†’ userGood
            ) => r.user_id === userId && r.value === 1
          );

          setUserActions({
            hasGood: !!userGood, // hasLiked â†’ hasGood
            goodId: userGood?.id, // likeId â†’ goodId
          });
        }
      }
    } catch (error: any) {
      console.error("âŒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:", error);

      if (error.response?.status === 404) {
        // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯æ­£å¸¸
        setStats({ goods: 0 });
        setUserActions({ hasGood: false });
      } else {
        setError("è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    } finally {
      setLoading(false);
    }
  }, [contentId, isAuthenticated]); // contentIdã¨isAuthenticatedã‚’ä¾å­˜é–¢ä¿‚ã«è¿½åŠ 

  useEffect(() => {
    const token = localStorage.getItem("token");
    setIsAuthenticated(!!token);
    fetchActions();
  }, [fetchActions]); // fetchActionsã‚’ä¾å­˜é–¢ä¿‚ã«è¿½åŠ 

  const handleGood = async () => {
    // handleLike â†’ handleGood
    if (!isAuthenticated) {
      alert("è©•ä¾¡ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
      return;
    }

    try {
      setSubmitting(true);
      setError(null);
      console.log("ğŸ‘ ã‚°ãƒƒãƒ‰å‡¦ç†é–‹å§‹");

      if (userActions.hasGood) {
        // hasLiked â†’ hasGood
        // ã‚°ãƒƒãƒ‰ã‚’å–ã‚Šæ¶ˆã—ï¼ˆå‰Šé™¤ï¼‰
        if (userActions.goodId) {
          // likeId â†’ goodId
          console.log("âŒ ã‚°ãƒƒãƒ‰å–ã‚Šæ¶ˆã—:", userActions.goodId);
          await api.deleteRating(userActions.goodId.toString());
          console.log("âœ… ã‚°ãƒƒãƒ‰å–ã‚Šæ¶ˆã—æˆåŠŸ");
        }
      } else {
        // ã‚°ãƒƒãƒ‰ã‚’è¿½åŠ 
        console.log("â• ã‚°ãƒƒãƒ‰è¿½åŠ ");
        await api.createOrUpdateRating(contentId, 1); // 1 = ã‚°ãƒƒãƒ‰
        console.log("âœ… ã‚°ãƒƒãƒ‰è¿½åŠ æˆåŠŸ");
      }

      await fetchActions();
    } catch (error: any) {
      console.error("âŒ ã‚°ãƒƒãƒ‰ã‚¨ãƒ©ãƒ¼:", error);
      setError("ã‚°ãƒƒãƒ‰ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ"); // ã„ã„ã­ â†’ ã‚°ãƒƒãƒ‰
    } finally {
      setSubmitting(false);
    }
  };

  if (loading) {
    return (
      <div
        style={{
          display: "flex",
          gap: currentSize.gap,
          alignItems: "center",
          fontSize: currentSize.fontSize,
        }}
      >
        ğŸ“Š èª­ã¿è¾¼ã¿ä¸­...
      </div>
    );
  }

  return (
    <div
      style={{
        padding: "1rem",
        border: "1px solid #e5e7eb",
        borderRadius: "8px",
        backgroundColor: "white",
      }}
    >
      {/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */}
      {error && (
        <div
          style={{
            backgroundColor: "#fee2e2",
            color: "#dc2626",
            padding: "0.5rem",
            borderRadius: "4px",
            marginBottom: "0.75rem",
            fontSize: "0.875rem",
          }}
        >
          âš ï¸ {error}
        </div>
      )}

      {/* ã‚°ãƒƒãƒ‰ãƒœã‚¿ãƒ³ã®ã¿ */}
      <div
        style={{
          display: "flex",
          gap: currentSize.gap,
          alignItems: "center",
          justifyContent: "center",
          flexWrap: "wrap",
        }}
      >
        <button
          onClick={handleGood} // handleLike â†’ handleGood
          disabled={submitting || !isAuthenticated}
          style={{
            display: "flex",
            alignItems: "center",
            gap: "0.375rem",
            padding: currentSize.padding,
            backgroundColor: userActions.hasGood ? "#dcfce7" : "transparent", // hasLiked â†’ hasGood
            color: userActions.hasGood ? "#059669" : "#6b7280",
            border: `1px solid ${userActions.hasGood ? "#059669" : "#d1d5db"}`,
            borderRadius: "8px",
            fontSize: currentSize.fontSize,
            cursor: isAuthenticated ? "pointer" : "not-allowed",
            opacity: submitting ? 0.6 : 1,
            transition: "all 0.2s ease",
            fontWeight: userActions.hasGood ? "600" : "400",
          }}
          title={isAuthenticated ? "ã‚°ãƒƒãƒ‰" : "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"} // ã„ã„ã­ â†’ ã‚°ãƒƒãƒ‰
        >
          <span style={{ fontSize: currentSize.iconSize }}>
            {userActions.hasGood ? "ğŸ‘" : "ğŸ¤"} {/* â¤ï¸ â†’ ğŸ‘ ã«å¤‰æ›´ */}
          </span>
          {showCounts && <span>{stats?.goods || 0}</span>}
          <span style={{ fontSize: "0.875em" }}>ã‚°ãƒƒãƒ‰</span>{" "}
          {/* ã„ã„ã­ â†’ ã‚°ãƒƒãƒ‰ */}
        </button>
      </div>

      {/* èªè¨¼çŠ¶æ…‹ã®è¡¨ç¤º */}
      {!isAuthenticated && (
        <div
          style={{
            textAlign: "center",
            marginTop: "0.75rem",
            fontSize: "0.75rem",
            color: "#6b7280",
          }}
        >
          ğŸ”’ è©•ä¾¡ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„
        </div>
      )}

      {/* ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹è¡¨ç¤º */}
      {showCounts &&
        isAuthenticated &&
        userActions.hasGood && ( // hasLiked â†’ hasGood
          <div
            style={{
              marginTop: "0.75rem",
              paddingTop: "0.75rem",
              borderTop: "1px solid #e5e7eb",
              fontSize: "0.75rem",
              color: "#6b7280",
              textAlign: "center",
            }}
          >
            <span>ğŸ‘ ã‚ãªãŸãŒã‚°ãƒƒãƒ‰ã—ã¾ã—ãŸ</span>{" "}
            {/* â¤ï¸ â†’ ğŸ‘, ã„ã„ã­ â†’ ã‚°ãƒƒãƒ‰ */}
          </div>
        )}
    </div>
  );
};

export default ContentActions;