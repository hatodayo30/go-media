import React, { useState, useEffect, useCallback } from "react";
import { ThumbsUp, ThumbsDown } from "lucide-react";
import { api } from "../services/api";

interface RatingProps {
  contentId: number;
  mode?: "like" | "star";
  showStats?: boolean;
  size?: "small" | "medium" | "large";
  onRatingChange?: (rating: number) => void;
}

interface RatingStats {
  likes: number;
  dislikes: number;
  userRating?: number; // 0 = ãƒãƒƒãƒ‰, 1 = ã„ã„ã­, undefined = æœªè©•ä¾¡
}

const Rating: React.FC<RatingProps> = ({
  contentId,
  mode = "like",
  showStats = true,
  size = "medium",
  onRatingChange,
}) => {
  const [stats, setStats] = useState<RatingStats>({
    likes: 0,
    dislikes: 0,
    userRating: undefined,
  });
  const [isLoading, setIsLoading] = useState(false);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const sizeClasses = {
    small: "text-sm px-2 py-1",
    medium: "text-base px-3 py-2",
    large: "text-lg px-4 py-3",
  };

  const currentSizeClass = sizeClasses[size];

  // çµ±è¨ˆæƒ…å ±ã‚’å–å¾—ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
  const fetchStats = useCallback(async () => {
    try {
      setError(null);
      console.log("ğŸ“Š çµ±è¨ˆæƒ…å ±å–å¾—é–‹å§‹:", contentId);

      // å¹³å‡è©•ä¾¡çµ±è¨ˆã‚’å–å¾—
      const averageResponse = await api.getAverageRating(contentId.toString());
      console.log("ğŸ“Š å¹³å‡è©•ä¾¡ãƒ¬ã‚¹ãƒãƒ³ã‚¹:", averageResponse);

      const avgData = averageResponse.data || averageResponse;

      setStats({
        likes: avgData.like_count || 0,
        dislikes: avgData.dislike_count || 0,
        userRating: undefined, // å€‹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼è©•ä¾¡ã¯çœç•¥ï¼ˆã‚·ãƒ³ãƒ—ãƒ«åŒ–ï¼‰
      });
    } catch (error: any) {
      console.error("âŒ çµ±è¨ˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:", error);

      // 404ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
      if (error.response?.status === 404) {
        setStats({
          likes: 0,
          dislikes: 0,
          userRating: undefined,
        });
      } else {
        setError("çµ±è¨ˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    }
  }, [contentId]); // contentIdã‚’ä¾å­˜é–¢ä¿‚ã«è¿½åŠ 

  useEffect(() => {
    const token = localStorage.getItem("token");
    setIsAuthenticated(!!token);
    fetchStats();
  }, [fetchStats]);

  // è©•ä¾¡ã‚’é€ä¿¡ - ä¿®æ­£ç®‡æ‰€
  const handleRating = async (rating: number) => {
    if (!isAuthenticated) {
      alert("è©•ä¾¡ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
      return;
    }

    if (isLoading) return;

    setIsLoading(true);
    setError(null);

    try {
      console.log("ğŸ”„ è©•ä¾¡é€ä¿¡ä¸­...", { contentId, rating });
      console.log("ğŸ“¤ é€ä¿¡äºˆå®šãƒ‡ãƒ¼ã‚¿:", { contentId, value: rating });

      // ä¿®æ­£: api.createOrUpdateRating ã®å‘¼ã³å‡ºã—æ–¹æ³•ã‚’å¤‰æ›´
      const response = await api.createOrUpdateRating(contentId, rating);

      console.log("âœ… è©•ä¾¡æŠ•ç¨¿æˆåŠŸ:", response);

      // çµ±è¨ˆæƒ…å ±ã‚’å†å–å¾—
      await fetchStats();

      // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
      onRatingChange?.(rating);
    } catch (error: any) {
      console.error("âŒ è©•ä¾¡æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:", error);
      if (error.response?.data) {
        console.error("âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°:", error.response.data);
      }

      let errorMessage = "è©•ä¾¡ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
      if (error.response?.status === 401) {
        errorMessage = "èªè¨¼ãŒå¿…è¦ã§ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚";
        localStorage.removeItem("token");
        setIsAuthenticated(false);
      } else if (error.response?.data?.error) {
        errorMessage = error.response.data.error;
      }

      setError(errorMessage);
      alert(errorMessage);
    } finally {
      setIsLoading(false);
    }
  };

  // ã„ã„ã­/ãƒ‡ã‚£ã‚¹ãƒ©ã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  const renderLikeButtons = () => {
    return (
      <div className="flex items-center gap-3">
        {/* ã„ã„ã­ãƒœã‚¿ãƒ³ */}
        <button
          onClick={() => handleRating(1)} // 1 = ã„ã„ã­
          disabled={isLoading || !isAuthenticated}
          className={`
            flex items-center gap-2 rounded-lg border transition-all duration-200
            ${currentSizeClass}
            ${
              stats.userRating === 1
                ? "bg-green-50 border-green-200 text-green-700 shadow-sm"
                : "bg-white border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300"
            }
            ${
              isLoading
                ? "opacity-50 cursor-not-allowed"
                : isAuthenticated
                ? "cursor-pointer"
                : "cursor-not-allowed opacity-60"
            }
          `}
          title={isAuthenticated ? "ã„ã„ã­" : "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"}
        >
          <ThumbsUp
            size={size === "small" ? 14 : size === "large" ? 20 : 16}
            className={stats.userRating === 1 ? "fill-current" : ""}
          />
          <span className="font-medium">{stats.likes}</span>
        </button>

        {/* ãƒ‡ã‚£ã‚¹ãƒ©ã‚¤ã‚¯ãƒœã‚¿ãƒ³ */}
        <button
          onClick={() => handleRating(0)} // 0 = ãƒãƒƒãƒ‰
          disabled={isLoading || !isAuthenticated}
          className={`
            flex items-center gap-2 rounded-lg border transition-all duration-200
            ${currentSizeClass}
            ${
              stats.userRating === 0
                ? "bg-red-50 border-red-200 text-red-700 shadow-sm"
                : "bg-white border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300"
            }
            ${
              isLoading
                ? "opacity-50 cursor-not-allowed"
                : isAuthenticated
                ? "cursor-pointer"
                : "cursor-not-allowed opacity-60"
            }
          `}
          title={isAuthenticated ? "ãƒ‡ã‚£ã‚¹ãƒ©ã‚¤ã‚¯" : "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"}
        >
          <ThumbsDown
            size={size === "small" ? 14 : size === "large" ? 20 : 16}
            className={stats.userRating === 0 ? "fill-current" : ""}
          />
          <span className="font-medium">{stats.dislikes}</span>
        </button>

        {/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */}
        {isLoading && (
          <div className="text-sm text-gray-500 flex items-center gap-1">
            <div className="w-4 h-4 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin"></div>
            æ›´æ–°ä¸­...
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="rating-component">
      {/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */}
      {error && (
        <div className="mb-3 p-2 bg-red-50 border border-red-200 rounded-md text-red-700 text-sm">
          âš ï¸ {error}
        </div>
      )}

      {/* èªè¨¼çŠ¶æ…‹ã®é€šçŸ¥ */}
      {!isAuthenticated && (
        <div className="mb-2 text-xs text-gray-500 flex items-center gap-1">
          ğŸ”’ è©•ä¾¡ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„
        </div>
      )}

      {/* è©•ä¾¡ãƒœã‚¿ãƒ³ */}
      {mode === "like" && renderLikeButtons()}

      {/* çµ±è¨ˆæƒ…å ± */}
      {showStats && (
        <div className="mt-3 pt-2 border-t border-gray-100">
          <div className="text-xs text-gray-500">
            ç·è©•ä¾¡æ•°: {stats.likes + stats.dislikes}ä»¶
          </div>
        </div>
      )}
    </div>
  );
};

export default Rating;